{% extends "blog_base/base_with_navbar.html" %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'community/css/navbar_override.css' %}">
{% endblock extra_head %}

{% block title %}{{ post.title }} | ììœ ê²Œì‹œíŒ{% endblock title %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<main class="site-body container-lg py-5" style="max-width: 960px;">

  <!-- âœ… ì œëª© + ë©”íƒ€ ì •ë³´ ì¹´ë“œ -->
  <div class="bg-dark text-white rounded shadow-sm p-4 mb-4">
    <h2 class="fw-bold">{{ post.title }}</h2>
    <div class="small text-secondary mt-2">
      ì‘ì„±ì: {{ post.author.nickname }} |
      ì‘ì„±ì¼: {{ post.created_at|date:"Y.m.d H:i" }} |
      ì¡°íšŒìˆ˜: {{ post.views }}
    </div>
  </div>

  <!-- âœ… ë‚´ìš© ì¹´ë“œ -->
  <div class="bg-light rounded p-4 mb-4">
    <div class="text-dark">
      {{ post.content|linebreaksbr }}
    </div>
  </div>

  <!-- âœ… ë²„íŠ¼ ì˜ì—­ -->
  <div class="d-flex justify-content-between mb-5">
    <a href="{% url 'community_list' %}" class="btn btn-outline-light">â† ëª©ë¡ìœ¼ë¡œ</a>
    {% if user == post.author %}
    <div class="d-flex gap-2">
      <a href="{% url 'community_update' post.id %}" class="btn btn-outline-light bi bi-pencil">ìˆ˜ì •</a>
      <a href="{% url 'community_delete' post.id %}" class="btn btn-outline-warning bi bi-trash">ì‚­ì œ</a>
    </div>
    {% endif %}
  </div>

  <!-- âœ… ëŒ“ê¸€ ì„¹ì…˜ -->
  <section class="mb-5">
    <h5 class="text-light mb-3">ğŸ’¬ ëŒ“ê¸€ {{ post.comments.count }}ê°œ</h5>

    {% for comment in comments %}
      {% if not comment.parent %}
      <div class="border rounded bg-dark text-white p-3 mb-3">
        <div class="d-flex justify-content-between small">
          <span>{{ comment.author.nickname }} | {{ comment.created_at|date:"Y.m.d H:i" }}</span>
          {% if user == comment.author %}
            <span>
              <a href="{% url 'comment_update' comment.id %}" class="text-warning me-2">ìˆ˜ì •</a>
              <a href="{% url 'comment_delete' comment.id %}" class="text-danger">ì‚­ì œ</a>
            </span>
          {% endif %}
        </div>
        <div class="mt-2">{{ comment.content|linebreaks }}</div>

        <!-- âœ… ëŒ€ëŒ“ê¸€ ëª©ë¡ -->
        {% for reply in comment.replies.all %}
          <div class="bg-secondary text-white mt-3 ms-3 p-2 rounded">
            <div class="d-flex justify-content-between small">
              <span>â†³ {{ reply.author.nickname }} | {{ reply.created_at|date:"Y.m.d H:i" }}</span>
              {% if user == reply.author %}
                <span>
                  <a href="{% url 'comment_update' reply.id %}" class="text-warning me-2">ìˆ˜ì •</a>
                  <a href="{% url 'comment_delete' reply.id %}" class="text-danger">ì‚­ì œ</a>
                </span>
              {% endif %}
            </div>
            <div class="mt-2">{{ reply.content|linebreaks }}</div>
          </div>
        {% endfor %}

        <!-- âœ… ëŒ€ëŒ“ê¸€ í¼ toggle -->
        <a href="#" class="text-info small mt-2 d-inline-block reply-toggle" data-id="{{ comment.id }}">â†ª ë‹µê¸€</a>

        <form method="post" action="{% url 'comment_create' post.id %}" class="mt-2 d-none reply-form" id="reply-form-{{ comment.id }}">
          {% csrf_token %}
          <input type="hidden" name="parent_id" value="{{ comment.id }}">
          <textarea name="content" rows="2" class="form-control mb-2" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
          <button type="submit" class="btn btn-sm btn-outline-light">ë‹µê¸€ ì‘ì„±</button>
        </form>
      </div>
      {% endif %}
    {% empty %}
      <p class="text-secondary">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endfor %}
  </section>

  <!-- âœ… ì¼ë°˜ ëŒ“ê¸€ ì‘ì„± í¼ -->
  {% if user.is_authenticated %}
    <form method="post" class="mt-4">
      {% csrf_token %}
      {{ comment_form }}
      <button type="submit" class="btn btn-outline-light mt-2">ëŒ“ê¸€ ì‘ì„±</button>
    </form>
  {% else %}
    <p class="text-white mt-3">ëŒ“ê¸€ ì‘ì„±ì„ ìœ„í•´ <a class="text-white" href="{% url 'account_login' %}">ë¡œê·¸ì¸</a> í•´ì£¼ì„¸ìš”.</p>
  {% endif %}

</main>

<!-- âœ… ëŒ€ëŒ“ê¸€ toggleìš© JS -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.reply-toggle').forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        const form = document.getElementById('reply-form-' + this.dataset.id);
        form.classList.toggle('d-none');
      });
    });
  });
</script>
{% endblock content %}
